<html>

  <head>
    <title>to-do rest</title>
    <style>
      li {cursor:pointer;}
    </style>
  </head>

  <body>
    <h1>to-do rest</h1>

    <ul id="list"></ul>

    <input id="add" type="button" value="Add" style="display:none;"/>
    <input id="search" type="button" value="Search" style="display:none;"/>
    <input id="refresh" type="button" value="Refresh"/>

  </body>

  <script type="text/javascript">

    var pg;

    window.onload = function() {
      pg = thisPage();
      pg.init();
    }

    var thisPage = function() {

      var g = {};
      g.msg = {};
      g.listUrl = '/to-do/';
      g.searchUrl = '';

      function init() {
        attachEvents();
        refreshList();
      }

      function refreshList() {
        makeRequest(g.listUrl,'list');
      }

      function searchList() {
        var text;

        text = prompt('Enter search:');
        if(text) {
          makeRequest(this.href.replace('{@text}',encodeURIComponent(text)),'search');
        }
      }

      function addToList() {
        var text;

        text = prompt('Enter text:');
        if(text) {
          makeRequest(this.href,'add','text='+encodeURIComponent(text));
        }
      }

      function completeItem() {
        makeRequest(this.href, 'complete', 'id='+this.id);
      }

      function showList() {
        var elm, li, i, x;

        // fill in the list
        elm = document.getElementById('list');
        if(elm) {
          elm.innerHTML = '';
          for(i=0,x=g.msg.collection.length;i<x;i++) {
            li = document.createElement('li');
            li.id = g.msg.collection[i].id;
            li.href = g.msg.collection[i].link.href;
            li.onclick = completeItem;
            li.title = 'click to delete';
            li.appendChild(document.createTextNode(g.msg.collection[i].text));
            elm.appendChild(li);
          }
        }

        // see if we should show buttons
        for(i=0,x=g.msg.links.length;i<x;i++) {
          switch(g.msg.links[i].rel) {
          case 'search':
          case 'add':
            showButton(g.msg.links[i]);
            break;
          }
        }
      }

      function showButton(link) {
        var elm;

        elm = document.getElementById(link.rel);
        if(elm) {
          elm.href = link.href;
          elm.style.display = 'inline';
        }
      }

      function attachEvents() {
        var elm;

        elm = document.getElementById('add');
        if(elm) {
          elm.onclick = addToList;
        }

        elm = document.getElementById('search');
        if(elm) {
          elm.onclick = searchList;
        }

        elm = document.getElementById('refresh');
        if(elm) {
          elm.onclick = refreshList;
        }
      }

      function makeRequest(href, context, body) {
        var ajax;

        ajax=new XMLHttpRequest();
        if(ajax) {

          if(body) {
            ajax.open('post',href,false);
            ajax.send(body);
          }
          else {
            ajax.open('get',href,false);
            ajax.send(null);
          }

          if(ajax.status===200 || ajax.status===204) {
            switch(context) {
              case 'list':
              case 'search':
                g.msg = JSON.parse(ajax.responseText);
                showList();
                break;
              case 'add':
              case 'complete':
                makeRequest(g.listUrl, 'list');
                break;
              default:
                alert('unknown context:'+context);
                break;
            }
          }
        }
      }

      var that = {};
      that.init = init;
      return that;
    }
  </script>
</html>